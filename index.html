<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EMS ‚Üí ELECTION-MONITORING-SYSTEM: EVERY PERSON IS LEGACY IN OUR COUNTRY</title>

<!-- Lucide Icons (Modern Feather) -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
/* ------------------------------ */

:root{
  --radius:16px;
  --transition:260ms cubic-bezier(.25,.9,.25,1);
  --font-main: "Inter", system-ui, -apple-system, "Segoe UI", Roboto;
  --font-lux: "Cormorant Garamond", serif;

  /* LUXURY ACCENTS */
  --royal-gold:#d5b27c;
  --royal-gold-soft:#e6cfa5;
  --royal-gold-glow:0 0 22px rgba(214,178,124,0.45);
  --royal-silver:#cfd3d8;

  /* NEON ACCENTS (subtle) */
  --accent1:#87e6ff;
  --accent2:#9affc9;

  /* LIGHT MODE */
  --page-bg: linear-gradient(180deg,#f8f9fb,#edf2f7);
  --text-primary:#0e1013;
  --text-muted:#666e78;
  --card-bg:rgba(255,255,255,0.75);
  --glass-border:rgba(0,0,0,0.12);
  --input-bg:rgba(0,0,0,0.07);
  --shadow-card:0 14px 34px rgba(0,0,0,0.15);
}

:root.dark{
  /* ROYAL ROLLS ROYCE DARK BACKGROUND */
  --page-bg:
    radial-gradient(900px 400px at 8% 8%, rgba(214,178,124,0.10), transparent),
    radial-gradient(900px 400px at 95% 95%, rgba(135,230,255,0.08), transparent),
    #070809; /* Onyx Black */

  --text-primary:#f5f6f7;
  --text-muted:#9fa5ac;
  --card-bg:rgba(14,16,20,0.55);
  --glass-border:rgba(255,255,255,0.10);
  --input-bg:rgba(255,255,255,0.06);
  --shadow-card:0 14px 34px rgba(214,178,124,0.1);
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:var(--font-main);
  background:var(--page-bg);
  color:var(--text-primary);
  transition:var(--transition);
}

/* ------------------------------
   LUXURY ORB BACKGROUND
------------------------------ */
.bg-orb{
  position:fixed;
  width:420px;height:420px;
  border-radius:50%;
  filter:blur(160px);
  opacity:0.22;
  z-index:-2;
}
#orb1{background:var(--royal-gold);top:-120px;left:-80px;}
#orb2{background:var(--accent1);bottom:-120px;right:-80px;}

/* ------------------------------
   HEADER
------------------------------ */
header{
  position:sticky;top:0;z-index:99;
  backdrop-filter:blur(14px);
  background:rgba(0,0,0,0.12);
  border-bottom:1px solid var(--glass-border);
  padding:16px 28px;
  display:flex;justify-content:space-between;align-items:center;
}

/* brand + logo container */
.brand-center{
  display:flex;align-items:center;gap:12px;
}
.brand-left{
  display:flex;align-items:center;gap:12px;
}
.brand-title{
  font-family:var(--font-lux);
  font-size:28px;font-weight:700;
  letter-spacing:.5px;
  color:var(--royal-gold);
}
.brand-sub{font-size:13px;color:var(--text-muted)}

/* NAV */
nav.top-nav{display:flex;align-items:center;gap:16px}
.nav-links{display:flex;gap:10px;list-style:none;}
.nav-links a{
  text-decoration:none;
  padding:10px 16px;
  font-weight:700;
  border-radius:10px;
  color:var(--text-muted);
  transition:var(--transition);
}
.nav-links a:hover{
  transform:translateY(-2px);
  color:var(--royal-gold);
}
.nav-links a.active{
  background:linear-gradient(90deg,#111,#1b1d20);
  border:1px solid var(--royal-gold-soft);
  color:var(--royal-gold);
  box-shadow:var(--royal-gold-glow);
}

/* BUTTON */
.btn{
  padding:12px 18px;
  border-radius:12px;
  background:linear-gradient(135deg,#111,#222);
  border:1px solid var(--royal-gold-soft);
  color:var(--royal-gold);
  font-weight:800;
  cursor:pointer;
  transition:var(--transition);
}
.btn:hover{
  transform:scale(1.05);
  box-shadow:var(--royal-gold-glow);
}
/* Fix dropdown visibility inside dark theme */
.input select {
  background: var(--card-bg);
  color: var(--text-primary);
  font-weight: 700;
  border-radius: 12px;
  padding: 12px;
  appearance: none;
}

/* Style options so they are visible */
.input select option {
  background: #111; /* dark background for popup list */
  color: var(--royal-gold-soft); /* golden text */
  font-weight: 700;
  padding: 10px;
  border: none;
}

/* Light theme fallback */
:root:not(.dark) .input select option {
  background: #fff;
  color: #222;
}

/* CARDS */
.card{
  background:var(--card-bg);
  border:1px solid var(--glass-border);
  padding:26px;
  border-radius:18px;
  backdrop-filter:blur(22px);
  box-shadow:var(--shadow-card);
  animation:fadeIn .45s ease;
}

/* ROLE CARDS */
.role-card{
  display:flex;align-items:center;gap:20px;
  padding:26px;border-radius:18px;
  background:var(--card-bg);
  border:1px solid var(--glass-border);
  cursor:pointer;transition:var(--transition);
}
.role-card:hover{
  transform:translateY(-6px);
  box-shadow:var(--royal-gold-glow);
  border-color:var(--royal-gold-soft);
}
.icon-box{
  width:80px;height:80px;border-radius:18px;
  display:grid;place-items:center;
  background:linear-gradient(135deg,#0b0c0d,#1b1d20);
  border:1px solid var(--royal-gold-soft);
  font-size:34px;
  color:var(--royal-gold);
  box-shadow:var(--royal-gold-glow);
}

/* INPUTS */
.input{
  background:var(--input-bg);
  padding:16px;border-radius:14px;
}
.input input, .input select, textarea{
  width:100%;background:transparent;border:none;
  color:var(--text-primary);font-weight:700;outline:none;
  font-size:15px;
}

/* HERO IMAGE */
.hero-image img{
  width:430px;border-radius:20px;
  filter:drop-shadow(0 0 30px rgba(0,0,0,0.45));
}

/* POPUP */
.overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.55);
  display:grid;place-items:center;
  opacity:0;visibility:hidden;
  transition:var(--transition);
}
.overlay.show{opacity:1;visibility:visible}
.popup{
  background:var(--card-bg);
  padding:24px;border-radius:16px;
  border:1px solid var(--glass-border);
  box-shadow:var(--shadow-card);
}

/* Fade animation */
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}

@keyframes blink{
  0%, 100%{opacity:1}
  50%{opacity:0.4}
}

section{display:none;}
section.active{display:block;}
/* small admin table styles */
.admin-table{width:100%;border-collapse:collapse;margin-top:10px}
.admin-table th,.admin-table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left;color:var(--text-primary);font-size:13px}
.admin-table thead th{font-weight:800;color:var(--royal-gold)}

/* solved status styling */
.status-solved{color:#8BC34A;font-weight:800}
.status-pending{color:var(--text-muted);font-weight:700}
</style>
</head>

<body>
<!-- BG ORBS -->
<div id="orb1" class="bg-orb"></div>
<div id="orb2" class="bg-orb"></div>

<header>
  <!-- logo + brand -->
  <div class="brand-center">
    <div class="brand-left" aria-hidden="false" style="align-items:center;">
      <!-- Election logo SVG (keeps royal-gold style) -->
      <svg width="40" height="40" viewBox="0 0 24 24" style="margin-right:8px;flex-shrink:0" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
        <g fill="none" fill-rule="evenodd">
          <circle cx="12" cy="12" r="11" fill="none" stroke="rgba(214,178,124,0.18)" stroke-width="1"/>
          <path d="M7 9h10v2H7zM7 13h10v2H7z" fill="#d5b27c"/>
          <rect x="4" y="6" width="16" height="12" rx="2" stroke="none" fill="rgba(213,178,124,0.03)"/>
        </g>
      </svg>

      <div>
        <div class="brand-title">EMS</div>
        <div class="brand-sub">Election Monitoring System</div>
      </div>
    </div>
  </div>

  <nav class="top-nav" aria-label="Main navigation">
    <ul class="nav-links" role="menubar">
      <li><a class="active" data-target="home" onclick="safeNav(event,'home')" role="menuitem">Home</a></li>
      <li><a data-target="citizen" onclick="safeNav(event,'citizen')" role="menuitem">Citizen</a></li>
      <li><a data-target="admin" onclick="safeNav(event,'admin')" role="menuitem">Admin</a></li>
      <li><a data-target="analyst" onclick="safeNav(event,'analyst')" role="menuitem">Analyst</a></li>
      <li><a data-target="observer" onclick="safeNav(event,'observer')" role="menuitem">Observer</a></li>
    </ul>

    <button class="btn" onclick="toggleTheme()" title="Toggle Theme" aria-pressed="false">
      <i data-lucide="sun"></i>
    </button>

    <!-- Logout button on right (Option A) -->
    <button class="btn" id="logoutBtn" onclick="logout()" title="Logout" style="display:none;margin-left:8px">
      Logout
    </button>
  </nav>
</header>

<main style="max-width:1100px;margin:30px auto;padding:0 20px">

  <!-- LOGIN -->
  <section id="login" class="active">
    <div class="card" style="display:flex;gap:20px;align-items:center;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
        <h2 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:30px;font-weight:700">
          Welcome to EMS
        </h2>
        <p id="login-desc" style="color:var(--text-muted)">Login with your Voter ID & Indian phone number. Select your role.</p>

        <form id="loginForm" onsubmit="return handleLogin(event)" autocomplete="off">
          <!-- Voter ID -->
          <div class="input" title="Voter ID format: 3 uppercase letters then 7 digits (e.g. APZ1234567)">
            <input id="voterId" type="text" placeholder="Voter ID (e.g. APZ1234567)" maxlength="10" required aria-label="Voter ID">
          </div>

          <!-- Phone -->
          <div class="input" style="margin-top:14px">
            <input id="phone" type="tel" placeholder="Phone (10 digits)" required aria-label="Phone">
          </div>

          <!-- Role dropdown -->
          <div class="input" style="margin-top:14px">
            <select id="roleSelect" required aria-label="Select your role">
              <option value="">Select Your Role</option>
              <option value="admin">Admin</option>
              <option value="citizen">Citizen</option>
              <option value="analyst">Analyst</option>
              <option value="observer">Observer</option>
            </select>
          </div>

          <div style="display:flex;gap:14px;margin-top:16px">
            <button class="btn" type="submit">Login / Register</button>
            <button class="btn" style="background:#444;color:var(--royal-gold-soft)" type="button" onclick="guestAttempt()">Guest</button>
          </div>
        </form>
      </div>

      <div class="hero-image" aria-hidden="true">
        <img src="https://images.unsplash.com/photo-1529107386315-e1a2ed48a620?q=80&w=900" alt="Voting Illustration">
      </div>
    </div>
  </section>

  <!-- HOME -->
  <section id="home">
    <h1 style="font-size:30px;font-family:var(--font-lux);font-weight:700;color:var(--royal-gold)">
      Make Elections Safer ¬∑ Make Voices Count
    </h1>
    <p style="color:var(--text-muted)">Select your role:</p>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:22px;margin-top:20px">

      <div class="role-card" onclick="safeNavClick('citizen')" role="button" tabindex="0">
        <div class="icon-box"><i data-lucide="shield-check"></i></div>
        <div><h3>Citizen</h3><p style="color:var(--text-muted)">Report issues securely</p></div>
      </div>

      <div class="role-card" onclick="safeNavClick('admin')" role="button" tabindex="0">
        <div class="icon-box"><i data-lucide="settings"></i></div>
        <div><h3>Admin</h3><p style="color:var(--text-muted)">Platform management</p></div>
      </div>

      <div class="role-card" onclick="safeNavClick('observer')" role="button" tabindex="0">
        <div class="icon-box"><i data-lucide="eye"></i></div>
        <div><h3>Observer</h3><p style="color:var(--text-muted)">Live booth monitoring</p></div>
      </div>

      <div class="role-card" onclick="safeNavClick('analyst')" role="button" tabindex="0">
        <div class="icon-box"><i data-lucide="bar-chart-3"></i></div>
        <div><h3>Analyst</h3><p style="color:var(--text-muted)">Charts & insights</p></div>
      </div>

    </div>
  </section>

  <!-- CITIZEN -->
  <section id="citizen">
    <div class="card">
      <h2 style="font-family:var(--font-lux);color:var(--royal-gold)">Citizen Portal</h2>
      <p style="color:var(--text-muted)">Describe an election issue:</p>
      <textarea id="issueText" style="width:100%;height:150px;margin-top:14px;border-radius:12px;background:var(--input-bg);color:var(--text-primary);padding:14px;border:none;outline:none"></textarea>
      <button class="btn" style="margin-top:14px" onclick="submitIssue()">Submit Issue</button>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="admin">
    <div class="card">
      <h2 style="font-family:var(--font-lux);color:var(--royal-gold)">Admin Panel</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:14px">
        <div class="card"><strong>Total Reports</strong><p id="metricTotal">12,842</p></div>
        <div class="card"><strong>Active Issues</strong><p id="metricActive">49</p></div>
      </div>

      <div style="margin-top:12px;display:grid;gap:12px">
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px" class="card"><strong>System Health</strong><div class="small-muted" style="margin-top:6px">All services operational</div></div>
          <div style="flex:1;min-width:220px" class="card"><strong>User Activity</strong><div class="small-muted" style="margin-top:6px">120 logins last hour</div></div>
        </div>

        <div>
          <div style="font-weight:900;margin-bottom:6px">Recent Logs</div>
          <table class="table" id="adminLogs">
            <thead><tr><th>Time</th><th>Activity</th></tr></thead>
            <tbody>
              <tr><td>10:12</td><td>New issue submitted (Booth 23)</td></tr>
              <tr><td>09:58</td><td>Observer reported crowding (District A)</td></tr>
              <tr><td>09:45</td><td>Analyst ran turnout model</td></tr>
            </tbody>
          </table>
        </div>

        <!-- NEW ISSUES (AUTO-UPDATED) inserted here -->
        <div style="margin-top:14px">
          <div style="font-weight:900;margin-bottom:8px">New Issues (Auto-Updated)</div>
          <table class="admin-table" id="adminIssueTable" aria-live="polite">
            <thead>
              <tr>
                <th>Time</th>
                <th>User</th>
                <th>Issue</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- new issues appended here -->
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </section>

  <!-- OBSERVER -->
  <section id="observer">
    <div class="card">
      <h2 style="font-family:var(--font-lux);color:var(--royal-gold);font-size:32px;margin-bottom:10px">üìä EMS Live Election Monitor</h2>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:24px">
        <span style="background:#dc143c;color:#fff;padding:8px 16px;border-radius:12px;font-weight:800;animation:blink 1s infinite">‚óè LIVE</span>
        <span style="color:var(--text-muted);font-size:13px">Real-time election monitoring</span>
      </div>

      <!-- LIVE STAT CARDS -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;margin-top:20px">
        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:22px">Total Reports</h3>
          <div style="font-size:40px;font-weight:800;color:var(--royal-gold-soft);margin-top:10px" id="reports">12,485</div>
        </div>

        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:22px">Verified Booths</h3>
          <div style="font-size:40px;font-weight:800;color:var(--royal-gold-soft);margin-top:10px" id="booths">4,892</div>
        </div>

        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:22px">Security Alerts</h3>
          <div style="font-size:40px;font-weight:800;color:var(--royal-gold-soft);margin-top:10px" id="alerts">47</div>
        </div>

        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:22px">Voter Turnout (%)</h3>
          <div style="font-size:40px;font-weight:800;color:var(--royal-gold-soft);margin-top:10px" id="turnout">68%</div>
        </div>
      </div>

      <!-- LIVE ALERT FEED -->
      <div class="card" style="margin-top:24px;border:1px solid var(--royal-gold-soft);box-shadow:var(--royal-gold-glow)">
        <h2 style="font-family:var(--font-lux);color:var(--royal-gold);font-size:26px;margin-bottom:16px">üö® Live Alert Feed</h2>
        <div id="liveAlerts" style="height:280px;overflow-y:auto;padding-right:12px;border-top:1px solid rgba(255,255,255,0.10);padding-top:14px">
          <div style="padding:12px;border-bottom:1px solid rgba(255,255,255,0.08);color:#ddd;display:flex;gap:10px">
            <span style="color:var(--royal-gold)">‚óè</span>
            <span><strong style="color:var(--royal-gold-soft)">Booth #1245:</strong> Verified setup completed</span>
          </div>
          <div style="padding:12px;border-bottom:1px solid rgba(255,255,255,0.08);color:#ddd;display:flex;gap:10px">
            <span style="color:#ff9800">‚óè</span>
            <span><strong style="color:#ffb74d">Region East:</strong> 92% polling stations active</span>
          </div>
          <div style="padding:12px;border-bottom:1px solid rgba(255,255,255,0.08);color:#ddd;display:flex;gap:10px">
            <span style="color:#2196f3">‚óè</span>
            <span><strong style="color:#64b5f6">Observer Report:</strong> No irregularities at polling centre #456</span>
          </div>
          <div style="padding:12px;border-bottom:1px solid rgba(255,255,255,0.08);color:#ddd;display:flex;gap:10px">
            <span style="color:var(--royal-gold)">‚óè</span>
            <span><strong style="color:var(--royal-gold-soft)">Booth #2034:</strong> Machine calibrated & ready</span>
          </div>
          <div style="padding:12px;border-bottom:1px solid rgba(255,255,255,0.08);color:#ddd;display:flex;gap:10px">
            <span style="color:#4caf50">‚óè</span>
            <span><strong style="color:#81c784">Region West:</strong> All booths operational</span>
          </div>
        </div>
      </div>

      <!-- LIVE UPDATES BUTTON -->
      <button class="btn" style="margin-top:20px;width:100%;padding:16px;font-size:16px" onclick="refreshLiveData()">
        <i data-lucide="refresh-cw" style="display:inline;margin-right:8px"></i>Refresh Live Data
      </button>
    </div>
  </section>

  <!-- ANALYST -->
  <section id="analyst">
    <div class="card">
      <h2 style="font-family:var(--font-lux);color:var(--royal-gold)">Analytics Dashboard</h2>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-top:20px">
        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:24px">Total Reports</h3>
          <div style="font-size:36px;font-weight:800;color:var(--royal-gold-soft);margin-top:10px">12,842</div>
        </div>
        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:24px">Verified Booths</h3>
          <div style="font-size:36px;font-weight:800;color:var(--royal-gold-soft);margin-top:10px">4,756</div>
        </div>
        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:24px">Security Alerts</h3>
          <div style="font-size:36px;font-weight:800;color:var(--royal-gold-soft);margin-top:10px">128</div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-top:20px">
        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:24px">Voting Trend</h3>
          <div id="lineChart" style="height:250px;margin-top:15px"></div>
        </div>
        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:24px">Reports by Category</h3>
          <div id="barChart" style="height:250px;margin-top:15px"></div>
        </div>
      </div>

      <div class="card" style="margin-top:20px">
        <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:24px">Issue Breakdown</h3>
        <div id="pieChart" style="height:300px;margin-top:15px"></div>
      </div>
    </div>
  </section>

</main>

<!-- POPUP -->
<div class="overlay" id="overlay" aria-hidden="true"><div class="popup" id="popup"></div></div>

<script>
/* ------------------------------
   Core DOM refs & init
------------------------------ */
const overlay = document.getElementById('overlay');
const popup = document.getElementById('popup');
lucide.createIcons();

/* ------------------------------
   Popup helper (reused everywhere)
------------------------------ */
function showPopup(title, sub){
  if(popup){
    popup.innerHTML = `<strong>${escapeHtml(title)}</strong><p style="color:var(--text-muted);margin-top:6px">${escapeHtml(sub)}</p>`;
  }
  if(overlay){
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    setTimeout(()=>{
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
    },1500);
  }
}

/* small escape util to avoid injecting raw HTML from user strings */
function escapeHtml(str){
  if(!str && str !== 0) return '';
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}

/* ------------------------------
   Auth helpers
------------------------------ */
function isLoggedIn(){ return localStorage.getItem("ems-logged")==="true"; }
function setLogged(x, voterId, role){
  if(x){
    localStorage.setItem("ems-logged","true");
    localStorage.setItem("ems-user", voterId);      // store voter id as user
    localStorage.setItem("ems-role", role);         // store role
  }else{
    localStorage.removeItem("ems-logged");
    localStorage.removeItem("ems-user");
    localStorage.removeItem("ems-role");
  }
}
function getRole(){ return (localStorage.getItem("ems-role")||'').toLowerCase(); }
function getUser(){ return localStorage.getItem("ems-user") || 'Unknown'; }

/* ------------------------------
   Navigation + role-based access
------------------------------ */
function showSection(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  const el = document.getElementById(id);
  if(el) el.classList.add("active");

  document.querySelectorAll(".nav-links a").forEach(a=>a.classList.remove("active"));
  const nav = document.querySelector(`.nav-links a[data-target="${id}"]`);
  if(nav) nav.classList.add("active");
}

/* safeNav used by nav links (with event) */
function safeNav(e,id){
  if(e && e.preventDefault) e.preventDefault();
  const role = getRole();
  if(!isLoggedIn()){ showPopup("Please login","Access restricted."); showSection("login"); return; }

  if(canAccessRole(role, id)){
    showSection(id);
  }else{
    showPopup("Access Denied", `You cannot access the ${capitalize(id)} role.`);
    // Stay in current section (do not navigate)
  }
}

/* safeNavClick used by role cards (no event) */
function safeNavClick(id){
  const role = getRole();
  if(!isLoggedIn()){ showPopup("Please login","Access restricted."); showSection("login"); return; }
  if(canAccessRole(role, id)){
    showSection(id);
  }else{
    showPopup("Access Denied", `You cannot access the ${capitalize(id)} role.`);
  }
}

/* Role access rules:
   - admin: access to all sections
   - others: only 'home' and their own section
*/
function canAccessRole(userRole, target){
  if(!userRole) return false;
  userRole = userRole.toLowerCase();
  target = target.toLowerCase();
  if(userRole === 'admin') return true;
  if(target === 'home') return true;
  return userRole === target;
}

function capitalize(s){
  if(!s) return s;
  return s.charAt(0).toUpperCase() + s.slice(1);
}

/* ------------------------------
   Login handling (Voter ID + Role)
   Voter ID format: 3 uppercase letters + 7 digits => /^[A-Z]{3}[0-9]{7}$/
------------------------------ */
function handleLogin(e){
  if(e && e.preventDefault) e.preventDefault();
  const voterIdRaw = (document.getElementById("voterId").value || '').trim();
  const voterId = voterIdRaw.toUpperCase();
  const phone = (document.getElementById("phone").value || '').trim();
  const role = (document.getElementById("roleSelect").value || '').trim().toLowerCase();

  const voterPattern = /^[A-Z]{3}[0-9]{7}$/;
  if(!voterPattern.test(voterId)){
    showPopup("Invalid Voter ID","Enter a valid Voter ID (3 uppercase letters followed by 7 digits, e.g. APZ1234567).");
    return false;
  }
  if(!/^[6-9]\d{9}$/.test(phone)){
    showPopup("Invalid Phone","Enter a valid 10-digit Indian number.");
    return false;
  }
  if(!role){
    showPopup("Missing Role","Please select your role to continue.");
    return false;
  }

  // set logged in
  setLogged(true, voterId, role);
  showPopup("Login Successful","Redirecting...");
  // show logout button
  document.getElementById('logoutBtn').style.display = 'inline-block';
  // after short delay, show home
  setTimeout(()=>{ showSection("home"); }, 900);
  return false;
}

function guestAttempt(){ showPopup("Guest Mode","Limited access only."); }

/* ------------------------------
   Issue management
   - Issues persist in localStorage key: 'ems-issues'
   - Each issue: { id, time, user, issue, status }
------------------------------ */

function loadIssuesFromStorage(){
  try{
    const raw = localStorage.getItem('ems-issues');
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)) return arr;
    return [];
  }catch(e){
    return [];
  }
}
function saveIssuesToStorage(arr){
  localStorage.setItem('ems-issues', JSON.stringify(arr));
}

/* render issues into admin table */
function renderAdminIssues(){
  const tbody = document.querySelector('#adminIssueTable tbody');
  if(!tbody) return;
  const issues = loadIssuesFromStorage();

  // clear
  tbody.innerHTML = '';
  if(issues.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="5" style="color:var(--text-muted)">No issues reported yet.</td>`;
    tbody.appendChild(tr);
    updateMetricsFromIssues(issues);
    return;
  }

  // sort newest first by id/time (id is timestamp-based)
  issues.sort((a,b)=>b.id - a.id);

  issues.forEach(issue => {
    const tr = document.createElement('tr');
    const statusClass = issue.status === 'Solved' ? 'status-solved' : 'status-pending';
    // safe values
    const timeSafe = escapeHtml(issue.time);
    const userSafe = escapeHtml(issue.user);
    const issueSafe = escapeHtml(issue.issue);

    // checkbox: only enable if pending
    const checkedAttr = issue.status === 'Solved' ? 'checked disabled' : '';
    const checkboxId = `chk-${issue.id}`;

    tr.innerHTML = `
      <td>${timeSafe}</td>
      <td>${userSafe}</td>
      <td>${issueSafe}</td>
      <td class="${statusClass}" id="status-${issue.id}">${escapeHtml(issue.status)}</td>
      <td>
        <input type="checkbox" id="${checkboxId}" ${checkedAttr} aria-label="Mark solved for ${issueSafe}">
      </td>
    `;

    tbody.appendChild(tr);

    // add event listener for checkbox when pending
    if(issue.status !== 'Solved'){
      const chk = document.getElementById(checkboxId);
      if(chk){
        chk.addEventListener('change', function(){
          if(this.checked){
            // update UI immediately
            const statusEl = document.getElementById(`status-${issue.id}`);
            if(statusEl){
              statusEl.textContent = 'Solved';
              statusEl.classList.remove('status-pending');
              statusEl.classList.add('status-solved');
              statusEl.style.color = '#8BC34A';
            }
            // disable checkbox
            this.disabled = true;
            // update storage
            markIssueSolved(issue.id);
            // update metrics
            refreshMetricsAfterSolve();
            showPopup('Issue Resolved','Status updated to Solved.');
          }
        });
      }
    }
  });

  // update metrics counts
  updateMetricsFromIssues(issues);
}

/* add new issue (called by submitIssue) */
function submitIssue(){
  if(!isLoggedIn()){
    showPopup("Please login","You must login to submit issues.");
    showSection("login");
    return;
  }

  const txt = (document.getElementById("issueText").value || '').trim();
  if(!txt){
    showPopup("Empty","Please describe the issue.");
    return;
  }

  // prepare issue object
  const now = new Date();
  const time = now.toLocaleString();
  const user = getUser();

  const issues = loadIssuesFromStorage();
  const id = Date.now(); // unique
  const issueObj = {
    id,
    time,
    user,
    issue: txt,
    status: 'Pending'
  };
  issues.push(issueObj);
  saveIssuesToStorage(issues);

  // re-render admin table
  renderAdminIssues();

  // update counters (increment active & total)
  const activeEl = document.getElementById('metricActive');
  const totalEl = document.getElementById('metricTotal');

  // try to parse numbers while preserving commas
  if(activeEl){
    const current = Number(String(activeEl.textContent || '0').replaceAll(',','')) || 0;
    activeEl.textContent = (current + 1).toLocaleString();
  }
  if(totalEl){
    const current = Number(String(totalEl.textContent || '0').replaceAll(',','')) || 0;
    totalEl.textContent = (current + 1).toLocaleString();
  }

  // clear input & show popup
  document.getElementById("issueText").value = '';
  showPopup("Issue Submitted","Thank you for reporting.");
}

/* mark issue solved in storage */
function markIssueSolved(issueId){
  const issues = loadIssuesFromStorage();
  const idx = issues.findIndex(i=>i.id === issueId);
  if(idx >= 0){
    issues[idx].status = 'Solved';
    saveIssuesToStorage(issues);
  }
}

/* update metrics from stored issues (used on load & render) */
function updateMetricsFromIssues(issues){
  const totalEl = document.getElementById('metricTotal');
  const activeEl = document.getElementById('metricActive');
  try{
    const pendingCount = issues.filter(i => i.status !== 'Solved').length;
    if(activeEl){
      activeEl.textContent = String(pendingCount);
    }
    if(totalEl){
      const baseline = Number(String(totalEl.textContent || '0').replaceAll(',','')) || 0;
      const computedTotal = Math.max(baseline, baseline + issues.length);
      totalEl.textContent = computedTotal.toLocaleString();
    }
  }catch(e){}
}

/* when an admin resolves an issue, adjust the Active counter */
function refreshMetricsAfterSolve(){
  const activeEl = document.getElementById('metricActive');
  if(!activeEl) return;
  let current = Number(String(activeEl.textContent || '0').replaceAll(',','')) || 0;
  current = Math.max(0, current - 1);
  activeEl.textContent = String(current);
}

/* ------------------------------
   Init: load stored issues and render
------------------------------ */
(function initApp(){
  lucide.createIcons();
  renderAdminIssues();
  const t = localStorage.getItem("ems-theme") || "dark";
  if(!document.documentElement.classList.contains(t)) document.documentElement.classList.add(t);

  // show logout button if logged in
  if(isLoggedIn()){
    document.getElementById('logoutBtn').style.display = 'inline-block';
    showSection('home');
  }else{
    showSection('login');
  }
})();

/* ------------------------------
   Theme Toggle
------------------------------ */
function toggleTheme(){
  const r=document.documentElement;
  if(r.classList.contains("dark")){
    r.classList.remove("dark");
    localStorage.setItem("ems-theme","light");
  }else{
    r.classList.add("dark");
    localStorage.setItem("ems-theme","dark");
  }
  lucide.createIcons();
}

/* ------------------------------
   Charts (unchanged)
------------------------------ */
if(document.querySelector("#lineChart")){
  new ApexCharts(document.querySelector("#lineChart"), {
    chart:{type:'line',height:250,toolbar:{show:false},foreColor:'#d5b27c'},
    stroke:{curve:'smooth',width:3},
    colors:['#d5b27c'],
    series:[
      {name:"Voter Turnout (%)",data:[22,36,48,55,68,74,81,89]}
    ],
    xaxis:{
      categories:["6AM","8AM","10AM","12PM","2PM","4PM","6PM","8PM"],
      labels:{style:{colors:'#d5b27c'}}
    },
    grid:{borderColor:"rgba(255,255,255,0.12)"}
  }).render();
}

/* BAR CHART - REPORTS BY CATEGORY */
if(document.querySelector("#barChart")){
  new ApexCharts(document.querySelector("#barChart"), {
    chart:{type:'bar',height:250,toolbar:{show:false},foreColor:'#d5b27c'},
    colors:['#d5b27c'],
    series:[
      {name:"Reports",data:[1540,1280,980,200,620]}
    ],
    xaxis:{
      categories:["Security","Machines","Booth Clash","Bribing","Technical"],
      labels:{style:{colors:'#d5b27c'}}
    },
    grid:{borderColor:"rgba(255,255,255,0.12)"}
  }).render();
}

/* PIE CHART - ISSUE BREAKDOWN */
if(document.querySelector("#pieChart")){
  new ApexCharts(document.querySelector("#pieChart"), {
    chart:{type:'pie',height:300},
    series:[45,25,15,10,5],
    labels:["Security","Technical","Management","Clashes","Other"],
    colors:["#d5b27c","#caa87a","#b0925f","#8a724e","#e9d8bd"],
    legend:{labels:{colors:'#f5f6f7'}}
  }).render();
}

/* ------------------------------
   LIVE DATA REFRESH - OBSERVER DASHBOARD
------------------------------ */
function refreshLiveData(){
  const metrics = {
    reports: ['12,485', '12,642', '12,758', '12,891'],
    booths: ['4,892', '4,921', '4,956', '4,987'],
    alerts: ['47', '52', '48', '51'],
    turnout: ['68%', '71%', '74%', '77%']
  };

  const alertMessages = [
    {icon:'‚óè',color:'var(--royal-gold)',msg:'<strong style="color:var(--royal-gold-soft)">Booth #1245:</strong> Verified setup completed'},
    {icon:'‚óè',color:'#ff9800',msg:'<strong style="color:#ffb74d">Region East:</strong> 92% polling stations active'},
    {icon:'‚óè',color:'#2196f3',msg:'<strong style="color:#64b5f6">Observer Report:</strong> No irregularities at polling centre #456'},
    {icon:'‚óè',color:'var(--royal-gold)',msg:'<strong style="color:var(--royal-gold-soft)">Booth #2034:</strong> Machine calibrated & ready'},
    {icon:'‚óè',color:'#4caf50',msg:'<strong style="color:#81c784">Region West:</strong> All booths operational'},
    {icon:'‚óè',color:'#ff5722',msg:'<strong style="color:#ffb74d">Alert:</strong> High turnout in Region North'},
    {icon:'‚óè',color:'#9c27b0',msg:'<strong style="color:#ce93d8">Verification:</strong> Documents checked at booth #789'}
  ];

  // Update metrics with random values
  const getRandomIndex = (arr)=>Math.floor(Math.random()*arr.length);
  document.getElementById('reports').textContent = metrics.reports[getRandomIndex(metrics.reports)];
  document.getElementById('booths').textContent = metrics.booths[getRandomIndex(metrics.booths)];
  document.getElementById('alerts').textContent = metrics.alerts[getRandomIndex(metrics.alerts)];
  document.getElementById('turnout').textContent = metrics.turnout[getRandomIndex(metrics.turnout)];

  // Update alerts feed
  const alertFeed = document.getElementById('liveAlerts');
  if(alertFeed){
    const randomAlerts = alertMessages.sort(()=>Math.random()-0.5).slice(0,5);
    alertFeed.innerHTML = randomAlerts.map(alert=>`
      <div style="padding:12px;border-bottom:1px solid rgba(255,255,255,0.08);color:#ddd;display:flex;gap:10px">
        <span style="color:${alert.color}">${alert.icon}</span>
        <span>${alert.msg}</span>
      </div>
    `).join('');
  }

  showPopup('Data Refreshed','Live metrics updated');
}

/* ------------------------------
   LOGOUT (clears session and shows login)
------------------------------ */
function logout(){
  setLogged(false);
  document.getElementById('logoutBtn').style.display = 'none';
  showPopup('Logged Out','Please login again.');
  showSection('login');
}
</script>
</body>
</html>

